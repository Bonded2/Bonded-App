<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover" />
  <title>Bonded App - Relationship Verification for Immigration</title>
  <meta name="description" content="Bonded helps you collect and organize proof of your genuine relationship for visa, residency and citizenship applications." />
  <meta name="keywords" content="visa application, relationship verification, immigration, citizenship, relationship proof" />
  <base href="/" />
  <link rel="icon" href="/favicon.ico" />
  <link rel="manifest" href="/manifest.json" crossorigin="use-credentials" />
  
  <!-- Content Security Policy - Permissive for development, external services, and Yoti -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval' blob: data: https://cdn.jsdelivr.net https://sdk.yoti.com; style-src 'self' 'unsafe-inline' blob: data: https://fonts.googleapis.com; style-src-elem 'self' 'unsafe-inline' blob: data: https://fonts.googleapis.com; font-src 'self' data: blob: https://fonts.gstatic.com; connect-src 'self' http: https: ws: wss: blob: data: https://*.yoti.com https://api.yoti.com wss://*.yoti.com; img-src 'self' data: blob: https:; media-src 'self' data: blob:; worker-src 'self' blob: data:; object-src 'none'; base-uri 'self'; frame-ancestors 'none'; form-action 'self'; upgrade-insecure-requests;" />
  
  <!-- Permissions Policy - Define allowed features -->
  <meta http-equiv="Permissions-Policy" content="camera=self, microphone=(), geolocation=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=(), ambient-light-sensor=(), autoplay=(), encrypted-media=(), fullscreen=self, picture-in-picture=()" />
  
  <!-- Early console filter - must be first script to catch all warnings -->
  <script>
    // Ultimate console warning suppression - catches everything
    (function() {
      'use strict';
      
      // Store original console methods
      const originalConsole = {
        log: console.log,
        warn: console.warn,
        error: console.error,
        info: console.info,
        debug: console.debug
      };
      
      // Comprehensive patterns for all known harmless warnings
      const suppressPatterns = [
        // Permissions Policy (most common)
        /Permissions-Policy.*Unrecognized/i,
        /Unrecognized feature.*interest-cohort/i,
        /Unrecognized feature.*browsing-topics/i,
        /Unrecognized feature.*join-ad-interest-group/i,
        /Unrecognized feature.*run-ad-auction/i,
        /Unrecognized feature.*shared-storage/i,
        /Unrecognized feature.*attribution-reporting/i,
        /Unrecognized feature.*trust-token-redemption/i,
        
        // TensorFlow.js warnings (very common)
        /TensorFlow\.js.*kernel.*already registered/i,
        /Duplicate kernel registration/i,
        /Platform browser has already been set/i,
        /webgl.*already registered/i,
        /tf\.Tensor.*disposed/i,
        /WARNING:tensorflow/i,
        /webgl.*not supported/i,
        /Backend.*already registered/i,
        
        // NSFWJS model warnings
        /nsfwjs.*warn/i,
        /nsfwjs.*error/i,
        /Loading.*nsfwjs/i,
        
        // ONNX Runtime warnings
        /onnxruntime.*warn/i,
        /WebGL.*context/i,
        
        // Content Security Policy (informational)
        /Content Security Policy.*directive/i,
        /CSP.*directive/i,
        
        // Service Worker warnings
        /service.*worker.*update/i,
        /SW.*registration/i,
        /Cache.*update/i,
        
        // React DevTools
        /Download.*React.*DevTools/i,
        /React.*DevTools.*not.*installed/i,
        
        // Source maps (common in dev)
        /DevTools.*source.*map/i,
        /Source.*map.*error/i,
        
        // WebGL warnings
        /WebGL.*warning/i,
        /WEBGL.*warning/i,
        /GPU.*warning/i,
        
        // Performance warnings (often harmless)
        /Performance.*entry/i,
        /Long.*task/i,
        
        // Font loading warnings
        /Font.*failed.*load/i,
        /font.*display.*swap/i,
        
        // PWA manifest warnings
        /Manifest.*warning/i,
        /PWA.*warning/i,
        
        // Cross-origin warnings (often expected)
        /Cross-origin.*warning/i,
        /CORS.*warning/i,
        
        // Third-party script warnings
        /third.*party.*script/i,
        /external.*script.*warning/i
      ];
      
      // Function to check if message should be suppressed
      function shouldSuppress(args) {
        const message = args.join(' ').toLowerCase();
        return suppressPatterns.some(pattern => pattern.test(message));
      }
      
      // Override all console methods
      console.log = function(...args) {
        if (!shouldSuppress(args)) {
          originalConsole.log.apply(console, args);
        }
      };
      
      console.warn = function(...args) {
        if (!shouldSuppress(args)) {
          originalConsole.warn.apply(console, args);
        }
      };
      
      console.error = function(...args) {
        if (!shouldSuppress(args)) {
          originalConsole.error.apply(console, args);
        }
      };
      
      console.info = function(...args) {
        if (!shouldSuppress(args)) {
          originalConsole.info.apply(console, args);
        }
      };
      
      console.debug = function(...args) {
        if (!shouldSuppress(args)) {
          originalConsole.debug.apply(console, args);
        }
      };
      
      // Also capture window.onerror for script errors
      const originalOnError = window.onerror;
      window.onerror = function(message, source, lineno, colno, error) {
        if (suppressPatterns.some(pattern => pattern.test(message))) {
          return true; // Suppress error
        }
        if (originalOnError) {
          return originalOnError.apply(window, arguments);
        }
        return false;
      };
      
      // Capture unhandled promise rejections that might be warnings
      const originalUnhandledRejection = window.onunhandledpromiserejection;
      window.onunhandledpromiserejection = function(event) {
        const message = event.reason?.message || event.reason?.toString() || '';
        if (suppressPatterns.some(pattern => pattern.test(message))) {
          event.preventDefault();
          return true;
        }
        if (originalUnhandledRejection) {
          return originalUnhandledRejection.apply(window, arguments);
        }
        return false;
      };
      
    })();
  </script>
  
  <!-- CDN AI libraries loading (with CSP compatibility) -->
  <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
  <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/nsfwjs@2.4.2/dist/nsfwjs.min.js"></script>
  <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.16.3/dist/ort.min.js"></script>
  <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.4/dist/tesseract.min.js"></script>
  <!-- Note: @xenova/transformers will be loaded dynamically when needed -->
  <script>
    // Enhanced AI libraries initialization with proper error handling
    window.aiInitPromise = new Promise((resolve, reject) => {
      let checkCount = 0;
      const maxChecks = 50;
      
      function checkAILibraries() {
        checkCount++;
        
        const tfReady = typeof window.tf !== 'undefined' && window.tf.ready;
        const nsfwReady = typeof window.nsfwjs !== 'undefined';
        const ortReady = typeof window.ort !== 'undefined';
        const tesseractReady = typeof window.Tesseract !== 'undefined';
        
        if (tfReady && nsfwReady && ortReady && tesseractReady) {
          // All AI libraries loaded from CDN
          
          // Initialize TensorFlow first
          window.tf.ready().then(() => {
            // TensorFlow ready
            // NSFWJS confirmed available globally
            // ONNX Runtime confirmed available globally
            // Tesseract confirmed available globally
            
            resolve({ 
              tf: window.tf, 
              nsfwjs: window.nsfwjs,
              ort: window.ort,
              tesseract: window.Tesseract
            });
          }).catch(reject);
          
        } else if (checkCount < maxChecks) {
          setTimeout(checkAILibraries, 100);
        } else {
          // AI libraries failed to load after timeout
          reject(new Error('AI libraries failed to load'));
        }
      }
      
      // Start checking after a brief delay to allow scripts to load
      setTimeout(checkAILibraries, 100);
    });
    
    // Log initialization status
    window.aiInitPromise.then((modules) => {
      // AI modules initialized successfully
    }).catch((error) => {
      // AI module initialization failed
    });
    
    // Legacy support - keep tfInitPromise for backward compatibility
    window.tfInitPromise = window.aiInitPromise;
  </script>

  <!-- Primary Theme Color for browsers -->
  <meta name="theme-color" content="#2C4CDF" />
  <meta name="msapplication-TileColor" content="#2C4CDF" />
  <meta name="msapplication-navbutton-color" content="#2C4CDF" />

  <!-- iOS PWA specific tags -->
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Bonded" />
  
  <!-- iOS splash screens -->
  <link rel="apple-touch-startup-image" href="/images/splash/apple-splash-2048-2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="/images/splash/apple-splash-1668-2388.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="/images/splash/apple-splash-1536-2048.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="/images/splash/apple-splash-1125-2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="/images/splash/apple-splash-1242-2688.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="/images/splash/apple-splash-828-1792.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="/images/splash/apple-splash-750-1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="/images/splash/apple-splash-640-1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
  
  <!-- iOS icons -->
  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="/images/apple-touch-icon-152x152.png" />
  <link rel="apple-touch-icon" sizes="167x167" href="/images/apple-touch-icon-167x167.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="/images/apple-touch-icon-120x120.png" />
  
  <!-- Microsoft Tiles -->
  <meta name="msapplication-TileImage" content="/images/ms-tile-144x144.png" />
  <meta name="msapplication-config" content="/browserconfig.xml" />
  
  <!-- Import Maps for ESM Dependencies -->
  <script type="importmap">
    {
      "imports": {
        "react": "https://cdn.jsdelivr.net/npm/react@18.2.0/+esm",
        "react-dom": "https://cdn.jsdelivr.net/npm/react-dom@18.2.0/+esm",
        "react-router-dom": "https://cdn.jsdelivr.net/npm/react-router-dom@6.8.1/+esm",
        "react-select": "https://cdn.jsdelivr.net/npm/react-select@5.10.1/+esm",
        "nsfwjs": "https://cdn.jsdelivr.net/npm/nsfwjs@4.2.1/+esm",
        "tesseract.js": "https://cdn.jsdelivr.net/npm/tesseract.js@6.0.1/+esm",
        "@xenova/transformers": "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0/+esm",
        "onnxruntime-web": "https://cdn.jsdelivr.net/npm/onnxruntime-web@1.16.3/+esm",
        "jspdf": "https://cdn.jsdelivr.net/npm/jspdf@3.0.1/+esm",
        "jszip": "https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm",
        "idb": "https://cdn.jsdelivr.net/npm/idb@7.1.1/+esm",
        "crypto-js": "https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/+esm",
        "workbox-window": "https://cdn.jsdelivr.net/npm/workbox-window@7.0.0/+esm",
        "buffer": "https://cdn.jsdelivr.net/npm/buffer@6.0.3/+esm",
        "crypto-browserify": "https://cdn.jsdelivr.net/npm/crypto-browserify@3.12.1/+esm",
        "stream-browserify": "https://cdn.jsdelivr.net/npm/stream-browserify@3.0.0/+esm",
        "core-js": "https://cdn.jsdelivr.net/npm/core-js@3.42.0/+esm"
      }
    }
  </script>
  
  <!-- Production ESM Preloads - ULTRA LIGHTWEIGHT LOADING -->
  <script type="module">
    // Check if production build - Now safely inside a module
    const isProduction = window.location.hostname.includes('icp0.io') || window.location.hostname.includes('ic0.app');
    
    if (isProduction) {
      console.log('🚀 Production ESM mode detected - preloading critical modules...');
      
      // Comprehensive ESM preloads for maximum performance
      const esmLibraries = [
        // Core React Ecosystem - Load first for immediate UI
        'https://cdn.jsdelivr.net/npm/react@18.2.0/+esm',
        'https://cdn.jsdelivr.net/npm/react-dom@18.2.0/+esm',
        'https://cdn.jsdelivr.net/npm/react-router-dom@6.8.1/+esm',
        'https://cdn.jsdelivr.net/npm/react-select@5.10.1/+esm',
        
        // Essential Utilities - Load early
        'https://cdn.jsdelivr.net/npm/idb@7.1.1/+esm',
        'https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/+esm',
        
        // AI Libraries - Load on demand
        'https://cdn.jsdelivr.net/npm/nsfwjs@4.2.1/+esm',
        'https://cdn.jsdelivr.net/npm/tesseract.js@6.0.1/+esm',
        'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0/+esm',
        'https://cdn.jsdelivr.net/npm/onnxruntime-web@1.16.3/+esm',
        
        // Document Processing - Load when needed
        'https://cdn.jsdelivr.net/npm/jspdf@3.0.1/+esm',
        'https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm',
        
        // PWA Support
        'https://cdn.jsdelivr.net/npm/workbox-window@7.0.0/+esm',
        
        // Polyfills - Load last
        'https://cdn.jsdelivr.net/npm/buffer@6.0.3/+esm',
        'https://cdn.jsdelivr.net/npm/core-js@3.42.0/+esm'
      ];
      
      // Alternative CDN URLs for fallback
      const alternativeCDNs = [
        // Skypack optimized ESM
        'https://cdn.skypack.dev/react@18.2.0',
        'https://cdn.skypack.dev/react-dom@18.2.0',
        'https://cdn.skypack.dev/react-router-dom@6.8.1',
        'https://cdn.skypack.dev/idb@7.1.1',
        'https://cdn.skypack.dev/nsfwjs@4.2.1',
        'https://cdn.skypack.dev/tesseract.js@6.0.1',
        'https://cdn.skypack.dev/@xenova/transformers@2.6.0',
        
        // unpkg ESM fallbacks
        'https://unpkg.com/react@18.2.0/index.js',
        'https://unpkg.com/react-dom@18.2.0/index.js',
        'https://unpkg.com/idb@7.1.1/build/index.js'
      ];
      
      // Add primary ESM preloads
      esmLibraries.forEach(url => {
        const link = document.createElement('link');
        link.rel = 'modulepreload';
        link.href = url;
        link.crossOrigin = 'anonymous';
        link.as = 'script';
        document.head.appendChild(link);
      });
      
      // Add alternative CDN preloads for redundancy
      alternativeCDNs.forEach(url => {
        const link = document.createElement('link');
        link.rel = 'dns-prefetch';
        link.href = url;
        document.head.appendChild(link);
      });
      
      // DNS prefetch for all CDN domains
      const cdnDomains = [
        'https://cdn.jsdelivr.net',
        'https://cdn.skypack.dev', 
        'https://unpkg.com',
        'https://esm.sh',
        'https://cdn.pika.dev'
      ];
      
      cdnDomains.forEach(domain => {
        const link = document.createElement('link');
        link.rel = 'dns-prefetch';
        link.href = domain;
        document.head.appendChild(link);
      });
      
      // Critical resource preconnects
      const preconnectDomains = [
        'https://cdn.jsdelivr.net',
        'https://cdn.skypack.dev'
      ];
      
      preconnectDomains.forEach(domain => {
        const link = document.createElement('link');
        link.rel = 'preconnect';
        link.href = domain;
        link.crossOrigin = 'anonymous';
        document.head.appendChild(link);
      });
      
      console.log('✅ Production ESM preloading complete');
    } else {
      console.log('🛠️ Development mode - using bundled dependencies');
    }
  </script>
  
  <!-- Performance optimizations -->
  <link rel="dns-prefetch" href="//fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  
  <!-- Meta tags for SEO and social sharing -->
  <meta name="description" content="Secure relationship verification app for immigration and visa applications. AI-powered evidence collection with privacy-first design." />
  <meta name="keywords" content="relationship verification, immigration, visa, evidence collection, privacy, AI" />
  
  <!-- Open Graph tags -->
  <meta property="og:title" content="Bonded - Relationship Evidence App" />
  <meta property="og:description" content="Secure relationship verification app for immigration and visa applications" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="/images/bonded-logo-blue.svg" />
  
  <!-- Twitter Card tags -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Bonded - Relationship Evidence App" />
  <meta name="twitter:description" content="Secure relationship verification app for immigration and visa applications" />
  <meta name="twitter:image" content="/images/bonded-logo-blue.svg" />
  
  <style>
    html, body, #root {
      margin: 0;
      padding: 0;
      border: none;
      width: 100%;
      height: 100%;
      overflow-x: hidden;
      overflow-y: auto;
      position: relative;
      -webkit-tap-highlight-color: transparent;
    }
    
    /* Add iOS specific styles for notched devices */
    @supports (padding-top: env(safe-area-inset-top)) {
      body, #root {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
      }
    }
  </style>
</head>

<body>
  <div id="root"></div>
  <script>
    // Comprehensive Node.js polyfills for browser compatibility
    
    // Polyfill global and Buffer
    if (typeof globalThis.global === 'undefined') {
      globalThis.global = globalThis;
    }
    
    if (typeof globalThis.Buffer === 'undefined') {
      globalThis.Buffer = {
        from: (data, encoding) => {
          if (typeof data === 'string') {
            return new TextEncoder().encode(data);
          }
          return new Uint8Array(data);
        },
        alloc: (size) => new Uint8Array(size),
        isBuffer: (obj) => obj instanceof Uint8Array,
        concat: (buffers) => {
          const totalLength = buffers.reduce((len, buf) => len + buf.length, 0);
          const result = new Uint8Array(totalLength);
          let offset = 0;
          for (const buf of buffers) {
            result.set(buf, offset);
            offset += buf.length;
          }
          return result;
        }
      };
    }
    
    // Polyfill process.env for Node.js compatibility
    if (typeof globalThis.process === 'undefined') {
      globalThis.process = { 
        env: { NODE_ENV: 'production' },
        browser: true,
        version: 'v16.0.0',
        versions: { node: '16.0.0' }
      };
    }
    
    // Polyfill module for CommonJS compatibility
    if (typeof globalThis.module === 'undefined') {
      globalThis.module = { exports: {} };
    }
    
    // Polyfill exports for CommonJS compatibility
    if (typeof globalThis.exports === 'undefined') {
      globalThis.exports = globalThis.module.exports;
    }
    
    // Polyfill require for basic compatibility
    if (typeof globalThis.require === 'undefined') {
      globalThis.require = function(module) {
        // require() polyfill called
        return {};
      };
    }
  </script>
  <script type="module" src="/src/main.jsx"></script>
  <script type="module" src="/src/sw-registration.js"></script>
  <noscript>You need to enable JavaScript to run this app.</noscript>
</body>

</html>