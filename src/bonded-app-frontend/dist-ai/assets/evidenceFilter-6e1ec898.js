var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,"name",{value,configurable:!0});import{_ as __vitePreload}from"./icp-sdk-b71c0736.js";import{textClassificationService}from"./textClassification-848edeeb.js";import{o as openDB}from"./vendor-e6e658b6.js";let nsfwjs;const NSFWJS_ESM_URL="https://cdn.skypack.dev/nsfwjs@4.2.1",NSFWJS_UNPKG_ESM_URL="https://unpkg.com/nsfwjs@4.2.1/dist/nsfwjs.esm.js",NSFWJS_JSDELIVR_ESM_URL="https://cdn.jsdelivr.net/npm/nsfwjs@4.2.1/+esm",_NSFWDetectionService=class _NSFWDetectionService{constructor(){this.model=null,this.isLoading=!1,this.loadError=null,this.isProduction=typeof window<"u"&&(window.location.hostname.includes("icp0.io")||window.location.hostname.includes("ic0.app")),this.nsfwKeywords=["nude","naked","porn","sex","explicit","adult","nsfw","erotic","sexual","xxx","genital","breast","nipple"]}async loadNSFWJS(){if(nsfwjs)return nsfwjs;try{if(this.isProduction){const esmUrls=[NSFWJS_JSDELIVR_ESM_URL,NSFWJS_ESM_URL,NSFWJS_UNPKG_ESM_URL];for(const url of esmUrls)try{nsfwjs=await __vitePreload(()=>import(url),[]);break}catch(urlError){if(console.warn(`❌ Failed to load from ${url}:`,urlError.message),url===esmUrls[esmUrls.length-1])throw urlError}}else nsfwjs=await __vitePreload(()=>import("./vendor-e6e658b6.js").then(n=>n.q),["assets/vendor-e6e658b6.js","assets/icp-sdk-b71c0736.js"])}catch(error){console.warn("⚠️ Failed to load NSFWJS:",error.message),nsfwjs=null}return nsfwjs}async loadModel(){if(this.model)return this.model;if(this.isLoading){for(;this.isLoading;)await new Promise(resolve=>setTimeout(resolve,100));return this.model}this.isLoading=!0,this.loadError=null;try{const nsfwjsLib=await this.loadNSFWJS();if(!nsfwjsLib)throw new Error("NSFWJS library not available");const nsfwjsAPI=nsfwjsLib.default||nsfwjsLib,loadStrategies=[()=>nsfwjsAPI.load(),()=>nsfwjsAPI.load("MobileNetV2Mid"),()=>nsfwjsAPI.load("InceptionV3")];for(let i=0;i<loadStrategies.length;i++)try{this.model=await loadStrategies[i]();const modelType=["Default MobileNetV2","MobileNetV2Mid","InceptionV3"][i],source=this.isProduction?"ESM CDN":"Bundled";break}catch(strategyError){if(console.warn(`Strategy ${i+1} failed:`,strategyError.message),i===loadStrategies.length-1)throw strategyError}if(!this.model)throw new Error("All model loading strategies failed")}catch(error){console.error("❌ NSFW model loading error:",error),this.loadError=error.message,this.model="fallback"}finally{this.isLoading=!1}return this.model}async detectNSFW(imageElement){try{const model=await this.loadModel();return model==="fallback"?await this.fallbackClassification(imageElement):await this.classifyWithNSFWJS(imageElement,model)}catch(error){return console.error("NSFW detection error:",error),{isNSFW:!1,confidence:.1,classification:"unknown",fallback:!0,error:error.message}}}async classifyWithNSFWJS(imageElement,model){try{const predictions=await model.classify(imageElement),predictionMap={};predictions.forEach(pred=>{predictionMap[pred.className]=pred.probability});const topPrediction=predictions[0];return{isNSFW:predictionMap.Porn>.6||predictionMap.Hentai>.7||predictionMap.Sexy>.8,confidence:topPrediction.probability,classification:topPrediction.className,allPredictions:predictions,thresholds:{porn:.6,hentai:.7,sexy:.8},fallback:!1,model:this.isProduction?"nsfwjs-esm-cdn":"nsfwjs-bundled"}}catch(error){return console.error("NSFWJS classification error:",error),await this.fallbackClassification(imageElement)}}async fallbackClassification(imageElement){try{const canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");canvas.width=imageElement.width||imageElement.videoWidth||224,canvas.height=imageElement.height||imageElement.videoHeight||224,ctx.drawImage(imageElement,0,0,canvas.width,canvas.height);const data=ctx.getImageData(0,0,canvas.width,canvas.height).data;let skinPixels=0,totalPixels=data.length/4;for(let i=0;i<data.length;i+=4){const r=data[i],g=data[i+1],b=data[i+2];r>95&&g>40&&b>20&&r>g&&r>b&&Math.abs(r-g)>15&&skinPixels++}const skinRatio=skinPixels/totalPixels,isNSFW=skinRatio>.7;return{isNSFW,confidence:skinRatio,classification:isNSFW?"high_skin_tone":"normal",fallback:!0,method:"skin_tone_analysis",model:"fallback"}}catch(error){return console.error("Fallback classification error:",error),{isNSFW:!1,confidence:.1,classification:"analysis_failed",fallback:!0,error:error.message,model:"fallback"}}}containsNSFWKeywords(text){if(!text||typeof text!="string")return!1;const lowerText=text.toLowerCase();return this.nsfwKeywords.some(keyword=>lowerText.includes(keyword))}async isImageSafe(imageElement){return!(await this.detectNSFW(imageElement)).isNSFW}getStatus(){return{isLoaded:!!this.model&&this.model!=="fallback",isLoading:this.isLoading,error:this.loadError,usingFallback:this.model==="fallback",modelType:this.model==="fallback"?"fallback":this.isProduction?"nsfwjs-esm-cdn":"nsfwjs-bundled"}}dispose(){this.model&&typeof this.model.dispose=="function"&&this.model.dispose(),this.model=null,this.loadError=null}};__name(_NSFWDetectionService,"NSFWDetectionService");let NSFWDetectionService=_NSFWDetectionService;const nsfwDetectionService=new NSFWDetectionService,detectNSFW=__name(imageElement=>nsfwDetectionService.detectNSFW(imageElement),"detectNSFW"),loadNSFWModel=__name(()=>nsfwDetectionService.loadModel(),"loadNSFWModel"),nsfwDetection=Object.freeze(Object.defineProperty({__proto__:null,detectNSFW,loadNSFWModel,nsfwDetectionService},Symbol.toStringTag,{value:"Module"}));let Tesseract;const TESSERACT_JSDELIVR_ESM_URL="https://cdn.jsdelivr.net/npm/tesseract.js@6.0.1/+esm",TESSERACT_SKYPACK_URL="https://cdn.skypack.dev/tesseract.js@6.0.1",TESSERACT_UNPKG_ESM_URL="https://unpkg.com/tesseract.js@6.0.1/dist/esm/index.js",_OCRService=class _OCRService{constructor(){this.worker=null,this.isInitialized=!1,this.isInitializing=!1,this.initError=null,this.isProduction=typeof window<"u"&&(window.location.hostname.includes("icp0.io")||window.location.hostname.includes("ic0.app")),this.loadError=null,this.defaultLanguage="eng",this.supportedLanguages=["eng","spa","fra","deu","por","ita","rus","chi_sim","chi_tra","jpn","ara"]}async loadTesseract(){if(Tesseract)return Tesseract;try{if(this.isProduction){const esmUrls=[TESSERACT_JSDELIVR_ESM_URL,TESSERACT_SKYPACK_URL,TESSERACT_UNPKG_ESM_URL];for(const url of esmUrls)try{Tesseract=await __vitePreload(()=>import(url),[]);break}catch(urlError){if(console.warn(`❌ Failed to load from ${url}:`,urlError.message),url===esmUrls[esmUrls.length-1])throw urlError}}else Tesseract=await __vitePreload(()=>import("./vendor-e6e658b6.js").then(n=>n.i),["assets/vendor-e6e658b6.js","assets/icp-sdk-b71c0736.js"])}catch(error){console.warn("⚠️ Failed to load Tesseract.js:",error.message),this.loadError=error.message,Tesseract=null}return Tesseract}async initialize(){if(this.isInitialized)return!0;try{if(!await this.loadTesseract())throw new Error("Tesseract.js library not available");return this.isInitialized=!0,!0}catch(error){return console.error("❌ OCR service initialization failed:",error),this.loadError=error.message,!1}}async initWorker(language=this.defaultLanguage){if(this.isInitialized&&this.worker)return this.worker;if(this.isInitializing){for(;this.isInitializing;)await new Promise(resolve=>setTimeout(resolve,100));return this.worker}this.isInitializing=!0,this.initError=null;try{const tesseractLib=await this.loadTesseract();if(!tesseractLib)throw new Error("Tesseract.js library not available");const tesseractAPI=tesseractLib.default||tesseractLib;this.worker=await tesseractAPI.createWorker(language),this.isInitialized=!0,this.isInitializing=!1;const source=this.isProduction?"ESM CDN":"Bundled";return this.worker}catch(error){return console.error("❌ Failed to initialize Tesseract.js worker:",error),this.initError=error,this.isInitializing=!1,null}}async extractText(imageInput,options={}){const startTime=Date.now();try{const worker=await this.initWorker(options.language);if(!worker)throw new Error("Failed to initialize Tesseract.js worker");let processedImage=imageInput;imageInput instanceof HTMLImageElement?processedImage=await this.imageElementToBlob(imageInput):(imageInput instanceof File||imageInput instanceof Blob)&&(processedImage=imageInput);const result=await worker.recognize(processedImage,{tessedit_char_whitelist:options.whitelist||"",tessedit_pageseg_mode:options.pageSegMode||"3",tessedit_ocr_engine_mode:options.ocrEngineMode||"3",...options.tesseractOptions}),processingTime=Date.now()-startTime,extractedText=result.data.text||"",confidence=result.data.confidence||0;return{success:!0,text:extractedText,confidence,processingTime,wordCount:extractedText.split(/\s+/).filter(word=>word.length>0).length,characterCount:extractedText.length,blocks:options.includeBlocks?result.data.blocks:void 0,words:options.includeWords?result.data.words:void 0,symbols:options.includeSymbols?result.data.symbols:void 0}}catch(error){const processingTime=Date.now()-startTime;return console.error("❌ OCR extraction failed:",error),{success:!1,text:"",confidence:0,processingTime,error:error.message,fallbackUsed:!0}}}async imageElementToBlob(imageElement){return new Promise((resolve,reject)=>{try{const canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),processImage=__name(()=>{canvas.width=imageElement.naturalWidth||imageElement.width,canvas.height=imageElement.naturalHeight||imageElement.height,ctx.drawImage(imageElement,0,0),canvas.toBlob(blob=>{blob?resolve(blob):reject(new Error("Failed to convert image to blob"))},"image/png",.9)},"processImage");imageElement.complete&&imageElement.naturalWidth>0?processImage():(imageElement.onload=processImage,imageElement.onerror=()=>reject(new Error("Failed to load image")))}catch(error){reject(error)}})}async extractTextFromMultipleImages(images,options={}){const results=[];for(let i=0;i<images.length;i++){const result=await this.extractText(images[i],options);results.push({index:i,filename:images[i].name||`image_${i}`,...result})}return results}getSupportedLanguages(){return this.supportedLanguages}isAvailable(){return this.isInitialized&&this.worker!==null}getStatus(){return{isInitialized:this.isInitialized,isInitializing:this.isInitializing,hasError:this.initError!==null,error:this.initError?.message,workerAvailable:this.worker!==null}}async dispose(){if(this.worker){try{await this.worker.terminate()}catch(error){console.warn("⚠️ Error terminating Tesseract.js worker:",error)}this.worker=null}this.isInitialized=!1,this.isInitializing=!1,this.initError=null}};__name(_OCRService,"OCRService");let OCRService=_OCRService;const ocrService=new OCRService,ocr=Object.freeze(Object.defineProperty({__proto__:null,default:ocrService,ocrService},Symbol.toStringTag,{value:"Module"})),_AIEvidenceFilter=class _AIEvidenceFilter{constructor(){this.db=null,this.settings={enableNSFWFilter:!0,enableFaceDetection:!1,enableTextFilter:!0,enableOCR:!0,requireHumanPresence:!1,allowManualOverride:!0},this.statistics={totalImagesProcessed:0,imagesApproved:0,imagesRejected:0,totalTextsProcessed:0,textsApproved:0,textsRejected:0,manualOverrides:0},this.initDB()}async initDB(){try{this.db=await openDB("BondedEvidenceFilterDB",1,{upgrade(db){db.objectStoreNames.contains("filterResults")||db.createObjectStore("filterResults",{autoIncrement:!0}).createIndex("timestamp","timestamp"),db.objectStoreNames.contains("settings")||db.createObjectStore("settings")}})}catch{}}async filterImage(imageInput,metadata={}){const startTime=Date.now(),result={type:"image",approved:!1,reasoning:"",details:{},timestamp:Date.now(),metadata};try{if(this.settings.enableNSFWFilter){const nsfwResult=await nsfwDetectionService.detectNSFW(imageInput);if(result.details.nsfwDetection=nsfwResult,nsfwResult.isNSFW)return result.reasoning=`Image contains NSFW content (${nsfwResult.classification}, confidence: ${Math.round(nsfwResult.confidence*100)}%)`,this.finalizeResult(result,startTime)}if(this.settings.enableOCR&&this.settings.enableTextFilter){const ocrResult=await ocrService.extractTextFromImage(imageInput);if(result.details.ocrExtraction=ocrResult,ocrResult.text&&ocrResult.text.trim().length>0){const textFilterResult=await textClassificationService.isExplicitText(ocrResult.text);if(result.details.textClassification=textFilterResult,textFilterResult.isExplicit)return result.reasoning=`Image contains explicit text: ${textFilterResult.reasoning}`,this.finalizeResult(result,startTime)}}return result.approved=!0,result.reasoning="Image passed all filters (visual content and extracted text)",this.finalizeResult(result,startTime)}catch(error){return result.reasoning=`Error: ${error.message}`,this.finalizeResult(result,startTime)}}async filterText(textInput,metadata={}){const startTime=Date.now(),result={type:"text",approved:!1,reasoning:"",details:{},timestamp:Date.now(),metadata};try{if(!this.settings.enableTextFilter)return result.approved=!0,result.reasoning="Text filtering disabled",this.finalizeResult(result,startTime);const validTexts=(Array.isArray(textInput)?textInput:[textInput]).filter(text=>text&&text.trim().length>0);if(validTexts.length===0)return result.reasoning="No valid text content",this.finalizeResult(result,startTime);const classificationResults=[];for(const text of validTexts){const classResult=await textClassificationService.isExplicitText(text);classificationResults.push(classResult)}result.details.textClassification=classificationResults;const explicitTexts=classificationResults.filter(r=>r.isExplicit);return explicitTexts.length>0?result.reasoning=`${explicitTexts.length} explicit text(s) detected`:(result.approved=!0,result.reasoning=`All ${validTexts.length} text(s) passed filters`),this.finalizeResult(result,startTime)}catch(error){return result.reasoning=`Error: ${error.message}`,this.finalizeResult(result,startTime)}}async filterEvidencePackage(evidencePackage){const packageResult={approved:!1,components:{},reasoning:"",timestamp:Date.now()};try{evidencePackage.photo&&(packageResult.components.photo=await this.filterImage(evidencePackage.photo,evidencePackage.photoMetadata)),evidencePackage.messages&&evidencePackage.messages.length>0&&(packageResult.components.messages=await this.filterText(evidencePackage.messages,evidencePackage.messagesMetadata));const photoApproved=!evidencePackage.photo||packageResult.components.photo?.approved,messagesApproved=!evidencePackage.messages||packageResult.components.messages?.approved;if(packageResult.approved=photoApproved&&messagesApproved,packageResult.approved)packageResult.reasoning="Evidence package approved";else{const reasons=[];photoApproved||reasons.push("Photo rejected"),messagesApproved||reasons.push("Messages rejected"),packageResult.reasoning=reasons.join("; ")}return packageResult}catch(error){return packageResult.reasoning=`Package filtering error: ${error.message}`,packageResult}}async applyManualOverride(originalResult,overrideReason){if(!this.settings.allowManualOverride)throw new Error("Manual overrides are disabled");const overrideResult={...originalResult,approved:!0,manualOverride:!0,originalReasoning:originalResult.reasoning,reasoning:`Manual override: ${overrideReason}`,overrideTimestamp:Date.now()};return this.statistics.manualOverrides++,overrideResult}async finalizeResult(result,startTime){return result.processingTime=Date.now()-startTime,result.type==="image"?(this.statistics.totalImagesProcessed++,result.approved?this.statistics.imagesApproved++:this.statistics.imagesRejected++):result.type==="text"&&(this.statistics.totalTextsProcessed++,result.approved?this.statistics.textsApproved++:this.statistics.textsRejected++),result}async updateSettings(newSettings){this.settings={...this.settings,...newSettings}}getStatistics(){return{...this.statistics}}getSettings(){return{...this.settings}}async getAIStatus(){return{nsfwDetection:nsfwDetectionService.getStatus(),textClassification:textClassificationService.getStatus(),ocr:ocrService.getStatus(),evidenceFilter:{settings:this.settings,statistics:this.getStatistics()}}}async cleanup(){try{await Promise.all([nsfwDetectionService.dispose(),textClassificationService.cleanup(),ocrService.cleanup()]),this.db&&(this.db.close(),this.db=null)}catch{}}};__name(_AIEvidenceFilter,"AIEvidenceFilter");let AIEvidenceFilter=_AIEvidenceFilter;const aiEvidenceFilter=new AIEvidenceFilter,evidenceFilter=Object.freeze(Object.defineProperty({__proto__:null,AIEvidenceFilter,aiEvidenceFilter},Symbol.toStringTag,{value:"Module"}));export{aiEvidenceFilter as a,evidenceFilter as e,nsfwDetection as n,ocr as o};
